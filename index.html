<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Q&A</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        .question-card { cursor: pointer; }
        .question-card.active { background-color: #e9ecef; }
        .answer-input { display: none; }
        .answer-input.active { display: block; }
        .evaluation { font-size: 0.9em; margin-top: 10px; }
        .answer-list { margin-top: 20px; }
        .answer-item { margin-bottom: 10px; }
        .stars-outer {
            display: inline-block;
            position: relative;
            font-family: FontAwesome;
        }
        .stars-outer::before {
            content: "\f006 \f006 \f006 \f006 \f006";
            color: #ccc;
        }
        .stars-inner {
            position: absolute;
            top: 0;
            left: 0;
            white-space: nowrap;
            overflow: hidden;
        }
        .stars-inner::before {
            content: "\f005 \f005 \f005 \f005 \f005";
            color: #f8ce0b;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Medical Q&A</h1>
        <div id="questions-list" class="list-group mb-4">
            <!-- Lista de întrebări va fi generată aici -->
        </div>
        <div id="answer-section" class="answer-input">
            <h4 id="selected-question"></h4>
            <form id="qa-form">
                <div class="form-group">
                    <label for="answer">Your Answer:</label>
                    <textarea class="form-control" id="answer" name="answer" rows="3" required></textarea>
                </div>
                <div id="evaluation" class="alert alert-info evaluation" role="alert"></div>
                <button type="submit" class="btn btn-primary mt-3">Submit</button>
            </form>
            <div id="answer-list" class="answer-list"></div>
        </div>
    </div>

    <script>
        let questions = [];
        let timer;

        function fetchQuestions() {
            fetch('http://127.0.0.1:5000/questions')
                .then(response => response.json())
                .then(data => {
                    questions = data;
                    renderQuestions();
                });
        }

        function renderQuestions() {
            const list = document.getElementById('questions-list');
            list.innerHTML = '';
            questions.forEach(q => {
                const item = document.createElement('a');
                item.className = 'list-group-item list-group-item-action question-card';
                item.dataset.id = q.question;
                item.innerText = q.question;
                if (q.answers.length > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-success ml-2';
                    badge.innerText = 'Answered';
                    item.appendChild(badge);
                }
                item.addEventListener('click', () => selectQuestion(q, item));
                list.appendChild(item);
            });
        }

        function selectQuestion(question, element) {
            const answerSection = document.getElementById('answer-section');
            document.getElementById('answer').value = '';
            document.getElementById('selected-question').innerText = question.question;
            answerSection.classList.add('active');

            // Mark selected question
            document.querySelectorAll('.question-card').forEach(item => item.classList.remove('active'));
            element.classList.add('active');

            renderAnswers(question.answers);
        }

        function renderAnswers(answers) {
            const answerList = document.getElementById('answer-list');
            answerList.innerHTML = '';
            answers.forEach(a => {
                const answerItem = document.createElement('div');
                answerItem.className = 'answer-item';
                answerItem.innerHTML = `<strong>Answer:</strong> ${a.answer} <br><strong>Score:</strong> ${a.score} ${renderStars(a.score)}`;
                answerList.appendChild(answerItem);
            });
        }

        function renderStars(score) {
            const starPercentage = (score / 1) * 100;
            const starPercentageRounded = `${Math.round(starPercentage / 20) * 20}%`;
            return `<div class="stars-outer"><div class="stars-inner" style="width:${starPercentageRounded}"></div></div>`;
        }

        document.getElementById('answer').addEventListener('input', function() {
            clearTimeout(timer);
            timer = setTimeout(() => {
                const answer = document.getElementById('answer').value;
                const selectedQuestionText = document.getElementById('selected-question').innerText;
                evaluateAnswer(selectedQuestionText, answer);
            }, 1000);
        });

        document.getElementById('qa-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const answer = document.getElementById('answer').value;
            const selectedQuestionText = document.getElementById('selected-question').innerText;
            const selectedQuestion = questions.find(q => q.question === selectedQuestionText);
            selectedQuestion.answers.push({ answer: answer, score: 0 }); // Score will be updated by evaluateAnswer
            evaluateAnswer(selectedQuestion.question, answer);
            fetchQuestions();
        });

        function evaluateAnswer(question, answer) {
            fetch('http://127.0.0.1:5000/evaluate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ question, answer }),
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('evaluation').innerText = data.evaluation;
                const selectedQuestion = questions.find(q => q.question === question);
                const answerIndex = selectedQuestion.answers.findIndex(a => a.answer === answer);
                if (answerIndex > -1) {
                    selectedQuestion.answers[answerIndex].score = parseFloat(data.evaluation.split(':')[1]);
                }
                renderAnswers(selectedQuestion.answers);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('evaluation').innerText = 'An error occurred while evaluating the answer.';
            });
        }

        fetchQuestions();
    </script>
</body>
<a href="https://www.flaticon.com/free-icons/star" title="star icons">Star icons created by Pixel perfect - Flaticon</a>
</html>
